---
title: "EDS 230/ESM 232 Sensitivity Analysis with LHS"
author: "Marie Rivers, Quin Smith, Ian Brunjes"
date: "4/25/2022"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
library(sensitivity)
library(tidyverse)
library(pse) # parameter space exploration with Latin Hypercubes
library(here)
```

# 1. Code a function to compute atmospheric conductance
```{r}
source(here("R", "compute_atm_cond.R"))
```

# 2. Run your model
**Estimate atmospheric conductance for a forest that is 10 meters high with a windspeed of 250 cm/s**
```{r}
atm_cond_q2 <- compute_atm_cond(h = 1000, v = 250)
#print(paste0('The calculated atmospheric conductance is ', round(atm_cond_q2$mean_atm_cond, 3), ' cm/s'))
print(paste0('The calculated atmospheric conductance is ', round(atm_cond_q2[[1]], 3), ' cm/s'))
```

# 3. Sensitivity Analysis
**3a. Use LHS to generate parameter values for the 4 parameters**
```{r}
# Lets consider the parameters....
factors = c("h", "kd", "k0", "v")

# Decide How many parameter sets to run
nsets=100

# choose distributions for parameters - this would come from
# what you know about the likely range of variation
q = c("qunif", "qnorm", "qnorm", "qnorm")
q.arg = list(list(min=950, max=1050), 
             list(mean=0.7, sd=(.01*0.7)), 
             list(mean=0.1, sd=(.01*0.1)), 
             list(mean=250, sd=30))
```

```{r}
# generate samples from LHS
sens_atm_cond = LHS(NULL, factors, nsets, q, q.arg)
sens_pars = get.data(sens_atm_cond) # table of all the parameters you want to run. Each row is a parameter set that will be run through the model
head(sens_pars)
```

**3b. Run you atmospheric conductance model for these parameters and return aerodynamic conductances**
```{r atm_cond sens}
# lets now run our model for all of the parameters generated by LHS
# pmap is useful here - it is a map function that uses the actual names of input parameters

atm_cond_q3 = sens_pars %>% pmap(compute_atm_cond)

# notice that what pmap returns is a list 
head(atm_cond_q3)
```

```{r}
# turn results in to a dataframe for easy display/analysis
atm_cond_df = atm_cond_q3 %>% map_dfr(`[`, "c_at")
```

**3c. Plot conductance estimates in a way that accounts for parameter uncertainty**
```{r}
plot_3c <- ggplot(data = atm_cond_df, aes(y = c_at)) +
  geom_boxplot() + 
  labs(title = "Sensitivity of Atmosphere Conductance Model",
       y = "atmospheric conductance (cm/s)")
plot_3c
```

**3d. Plot conductance estimates against each of your parameters**
```{r}
sens_atm_cond = pse::tell(sens_atm_cond, t(as.matrix(atm_cond_df)), # needs to be a matrix
                        res.names=c("Atmospheric Conductance"))
```

```{r}
plot_3d <- pse::plotscatter(sens_atm_cond, col="blue", cex=5)
plot_3d
```

**3e. Estimate the Partial Rank Correlation Coefficients**
```{r}
# prcc's automatically generated and easy to plot
pse::plotprcc(sens_atm_cond)
```

```{r}
sens_atm_cond$prcc
```

**3f. Discuss what your results tell you about how aerodynamic conductance varies with the different parameters? What does it suggest about what you should focus on if you want to reduce uncertainty in aerodynamic conductance estimates? Does this tell you anything about the sensitivity of plant water use to climate change?**

Based on the partial rank correlation coefficients, the estimated value of atmospheric conductance is most sensitive to windspeed (v). Atmospheric conductance and windspeed are positively correlated (atmospheric conductance increase as windspeed increases). To reduce uncertainty in atmospheric conductance estimates, you should focus on accurately measuring windspeed. If climate change results in increased windspeeds, then this would contribute to increased water use in plants. 







